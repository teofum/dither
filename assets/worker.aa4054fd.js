(function(){"use strict";const v=[{x:1,y:0,w:.4375},{x:-1,y:1,w:.1875},{x:0,y:1,w:.3125},{x:1,y:1,w:.0625}],A=[{x:1,y:0,w:7/48},{x:2,y:0,w:5/48},{x:-2,y:1,w:3/48},{x:-1,y:1,w:5/48},{x:0,y:1,w:7/48},{x:1,y:1,w:5/48},{x:2,y:1,w:3/48},{x:-2,y:2,w:1/48},{x:-1,y:2,w:3/48},{x:0,y:2,w:5/48},{x:1,y:2,w:3/48},{x:2,y:2,w:1/48}],p=[{x:1,y:0,w:8/42},{x:2,y:0,w:4/42},{x:-2,y:1,w:2/42},{x:-1,y:1,w:4/42},{x:0,y:1,w:8/42},{x:1,y:1,w:4/42},{x:2,y:1,w:2/42},{x:-2,y:2,w:1/42},{x:-1,y:2,w:2/42},{x:0,y:2,w:4/42},{x:1,y:2,w:2/42},{x:2,y:2,w:1/42}],C=[v,A,p];function M(r,o=2.2){return r.map(s=>{let n=s/255;return n=n>.04045?Math.pow((n+.055)/1.055,o):n/12.92,n*100})}function N(r,o=2.2){return r.map(s=>{let n=s/100;return n=n>.0031308?1.055*Math.pow(n,1/o)-.055:n*12.92,~~(n*255)})}var w=(r=>(r[r.Indexed=0]="Indexed",r[r.Mono=1]="Mono",r[r.RGB=2]="RGB",r[r.Mixer=3]="Mixer",r[r.Auto=4]="Auto",r))(w||{});const R=(r,o)=>{const n=r.data.slice(0,4)[1]===1,f=(r.data.length-4)/5,e=n?[255,255,255]:[0,0,0],a=c=>r.data[4+c*5],x=c=>r.data[5+c*5],m=c=>r.data.slice(6+c*5,9+c*5),t=c=>{let i=o;for(let d=0;d<c;d++)i=~~(i/a(d));return i%a(c)};for(let c=0;c<f;c++)m(c).forEach((i,d)=>{n&&(i=255-i);const y=~~(i*x(c)),u=i-y,l=y+t(c)*~~(u/(a(c)-1));e[d]+=n?-l:l,e[d]<0&&(e[d]=0),e[d]>255&&(e[d]=255)});return e},E=r=>{switch(r.type){case w.Indexed:return r.data.length/3;case w.Mono:return r.data[0];case w.RGB:return r.data[0]*r.data[1]*r.data[2];case w.Mixer:{const o=(r.data.length-4)/5;let s=1;for(let n=0;n<o;n++)s*=r.data[4+n*5];return s}case w.Auto:return r.data[0];default:return 0}},D=(r,o)=>{if(o<0||o>=E(r))throw new Error(`Color index ${o} out of bounds`);switch(r.type){case w.Indexed:return r.data.slice(o*3,o*3+3);case w.Mono:return r.data.slice(2,5).map(s=>{const n=~~(s*r.data[1]),f=s-n;return n+o*~~(f/(r.data[0]-1))});case w.Mixer:return R(r,o);case w.RGB:{const s=o%r.data[2],n=~~(o/r.data[2])%r.data[1];return[~~(o/(r.data[2]*r.data[1])),n,s].map((e,a)=>e*~~(255/(r.data[a]-1)))}case w.Auto:default:throw new Error("Invalid or Auto palette type")}},G=r=>Array.from({length:E(r)},(o,s)=>D(r,s));function B(r,o,s){let n=[],f=Number.POSITIVE_INFINITY;for(let e=0;e<o.length;e++){const a=s(r,o[e]);a<=f&&(n=o[e],f=a)}return n}const S=(r,o)=>(r[0]-o[0])*(r[0]-o[0])+(r[1]-o[1])*(r[1]-o[1])+(r[2]-o[2])*(r[2]-o[2]);function k(r,o,s,n){const f=r.width*r.height*4,e=r.width*4,a=C[s.matrix||0];if(!o.palette.palette)throw new Error("null palette");const x=G(o.palette.palette),m=s.gamma||2.2;for(let t=0;t<f;t+=4){const c=M(Array.from(r.data.slice(t,t+3)),m);for(let i=0;i<3;i++)r.data[t+i]=c[i];t%(e*4)===0&&n&&n(t,f,r)}for(let t=0;t<x.length;t++)x[t]=M(x[t],m);for(let t=0;t<f;t+=4){const c=Array.from(r.data.slice(t,t+3)),i=B(c,x,S),d=t%e/4;for(let u=0;u<3;u++)r.data[t+u]=N(i,m)[u];const y=c.map((u,l)=>u-i[l]);for(let u=0;u<a.length;u++){const l=t+a[u].x*4+a[u].y*e;if(d+a[u].x>=0&&d+a[u].x<r.width)for(let h=0;h<3;h++)r.data[l+h]+=y[h]*a[u].w}t%(4*e)===0&&n&&n(t,f,r)}return r}const z=[{id:"ProcErrorDiffusion",name:"Error Diffusion",run:k,maxAllowedPaletteSize:65536,supports:{threads:!1,gamma:!0},complexity:r=>r*2}],L=Array.from({length:100001});function V(r){for(let o=0;o<=1e5;o++)L[o]=Math.pow(o/1e5,1/r)*255}const g=self,I=(r,o,s)=>{g.postMessage({msg:0,params:{current:r,total:o,partial:s}})};g.addEventListener("message",r=>{var e;const o=r.data,s=(e=o.options.process.process)==null?void 0:e.name,n=o.options.process.settingValues,f=z.find(a=>a.name===s);if(!f){g.postMessage({msg:2,params:{error:`WorkerInit failed: process ${s} not found`}}),self.close();return}V(n.gamma||2.2),f.run(o.dataIn,o.options,n,I),g.postMessage({msg:1,params:{result:o.dataIn}}),self.close()})})();
